name: CI
on: [push]
jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: apt-get install packages
      run: sudo apt-get update -qq &&
           sudo apt-get install --no-install-recommends -y
               gcc
               make
               clang
               libudev-dev
               libsdl2-dev
               libsdl2-ttf-dev
               gcc-arm-none-eabi
               libnewlib-arm-none-eabi
    - name: Build libopencm3
      run: make -j4 -C libopencm3
    - name: Build firmware
      run: make
    - name: Build bloodview (gcc)
      run: make -BC bloodview
    - name: Build bloodview (clang)
      run: CC=clang make -BC bloodview
    - name: Build tools (gcc)
      run: make -BC tools
    - name: Build tools (clang)
      run: CC=clang make -BC tools

  Code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: apt-get install packages
      run: sudo apt-get update -qq &&
           sudo apt-get install --no-install-recommends -y
               make
               cppcheck
               shellcheck
               clang-tools
               libudev-dev
               libsdl2-dev
               libsdl2-ttf-dev
    - name: Shellcheck
      run: shellcheck run.sh
    - name: Clang scan-build bloodview
      run: scan-build make -BC bloodview
    - name: Clang scan-build tools
      run: scan-build make -BC tools
    - name: Cppcheck bloodview
      run: cppcheck --enable=warning,performance,portability,information --std=c11 bloodview/
    - name: Cppcheck tools
      run: cppcheck --enable=warning,performance,portability,information --std=c11 tools/
    - name: Cppcheck firmware
      run: cppcheck --enable=warning,performance,portability,information --std=c11 src/
